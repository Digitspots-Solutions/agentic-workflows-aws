# ‚úÖ LAUTECH RDS PostgreSQL Setup - COMPLETE

**Date**: January 5, 2026
**AWS Account**: 715841330456
**Region**: us-east-1 (US East N. Virginia)

---

## üéØ Summary

Successfully migrated LAUTECH database from SQLite to Amazon RDS PostgreSQL with all data intact, including the dance fee (‚Ç¶15,000).

---

## üìä RDS Instance Details

### Connection Information
- **Instance Identifier**: `lautech-agentcore-db`
- **Endpoint**: `lautech-agentcore-db.c2x6a0cseynp.us-east-1.rds.amazonaws.com`
- **Port**: `5432`
- **Database Name**: `lautech_db`
- **Username**: `lautech_admin`
- **Password**: Stored in AWS Secrets Manager (see below)

### Instance Configuration
- **Engine**: PostgreSQL 16.11
- **Instance Class**: db.t3.micro (1 vCPU, 1 GB RAM)
- **Storage**: 20 GB gp3 (General Purpose SSD)
- **IOPS**: 3000
- **Throughput**: 125 MB/s
- **Multi-AZ**: No (can be enabled for production)
- **Publicly Accessible**: Yes (for initial setup)
- **Encryption**: Yes (at rest using AWS KMS)
- **Backup Retention**: 7 days
- **Backup Window**: 03:00-04:00 UTC
- **Maintenance Window**: Sunday 04:00-05:00 UTC
- **CloudWatch Logs**: Enabled (PostgreSQL logs)

### Network Configuration
- **VPC**: vpc-06af626aaa35e2c51 (default VPC)
- **Security Group**: sg-0e4268cc96512c408
  - Inbound: PostgreSQL (port 5432) from 0.0.0.0/0
  - **Note**: For production, restrict to Lambda security group
- **Subnet Group**: lautech-agentcore-db-subnet-group (6 subnets across all AZs)

---

## üîê AWS Secrets Manager

### Secret Details
- **Secret Name**: `lautech/rds/credentials`
- **Secret ARN**: `arn:aws:secretsmanager:us-east-1:715841330456:secret:lautech/rds/credentials-yXk8nl`
- **Region**: us-east-1

### Secret Contents
```json
{
  "engine": "postgres",
  "host": "lautech-agentcore-db.c2x6a0cseynp.us-east-1.rds.amazonaws.com",
  "port": 5432,
  "username": "lautech_admin",
  "password": "<auto-generated-secure-password>",
  "dbname": "lautech_db",
  "dbInstanceIdentifier": "lautech-agentcore-db"
}
```

### Retrieve Secret (via AWS CLI)
```bash
aws secretsmanager get-secret-value \
  --secret-id lautech/rds/credentials \
  --region us-east-1 \
  --query SecretString \
  --output text | jq .
```

---

## üì¶ Data Migration Status

### Migration Summary
‚úÖ **All data successfully migrated**

| Table | Records Migrated | Status |
|-------|-----------------|--------|
| courses | 20 | ‚úÖ Complete |
| fees | 21 | ‚úÖ Complete (incl. dance fee) |
| academic_calendar | 36 | ‚úÖ Complete |
| hostels | 8 | ‚úÖ Complete |

### Special Data Verified
- ‚úÖ Dance fee (‚Ç¶15,000) confirmed in fees table
- ‚úÖ All course prerequisites preserved
- ‚úÖ All calendar events with dates intact
- ‚úÖ All hostel facilities information preserved

---

## üöÄ Next Steps for Production Deployment

### 1. Update Lambda Environment Variables

Add these environment variables to your Lambda function:

```bash
USE_POSTGRES=true
DB_SECRET_NAME=lautech/rds/credentials
AWS_REGION=us-east-1
```

**Via AWS CLI:**
```bash
aws lambda update-function-configuration \
  --function-name <your-lambda-function-name> \
  --environment "Variables={
    USE_POSTGRES=true,
    DB_SECRET_NAME=lautech/rds/credentials,
    AWS_REGION=us-east-1
  }" \
  --region us-east-1
```

### 2. Update IAM Role Permissions

Your Lambda execution role needs permissions to:
1. Read from Secrets Manager
2. Access RDS (optional, mainly for monitoring)
3. Create network interfaces (if Lambda is in VPC)

**Required IAM Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "SecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": "arn:aws:secretsmanager:us-east-1:715841330456:secret:lautech/rds/credentials-*"
    },
    {
      "Sid": "RDSDescribe",
      "Effect": "Allow",
      "Action": [
        "rds:DescribeDBInstances"
      ],
      "Resource": "arn:aws:rds:us-east-1:715841330456:db:lautech-agentcore-db"
    }
  ]
}
```

**Apply via script:**
```bash
cd /Users/MAC/projects/agentic-workshop/strands_agents/lautech
python update_iam_permissions.py
```

### 3. Deploy Updated Code

Deploy the updated `lautech_agentcore.py` which includes:
- `db_utils.py` - Database abstraction layer (SQLite + PostgreSQL)
- PostgreSQL support via psycopg2-binary
- Environment-based database selection

**Using AgentCore CLI:**
```bash
cd /Users/MAC/projects/agentic-workshop/strands_agents/lautech
agentcore deploy
```

### 4. Test the Deployment

**Test with a simple query:**
```bash
agentcore invoke '{
  "prompt": "What are the fees for 100 Level students?",
  "session_id": "test-session-001"
}' --region us-east-1
```

**Expected response should include:**
- Tuition + Acceptance Fee: ‚Ç¶100,000

**Test dance fee query:**
```bash
agentcore invoke '{
  "prompt": "How much is the dance fee?",
  "session_id": "test-session-002"
}' --region us-east-1
```

**Expected response:**
- Dance fee: ‚Ç¶15,000

---

## üìÅ Files Created/Modified

### New Files
1. `setup_rds.py` - RDS creation automation script
2. `migrate_to_rds.py` - SQLite to PostgreSQL migration script
3. `db_utils.py` - Database abstraction layer
4. `update_iam_permissions.py` - IAM policy updater
5. `RDS_SETUP_COMPLETE.md` - This file

### Modified Files
1. `lautech_agentcore.py` - Updated to use db_utils
2. `requirements.txt` - Added psycopg2-binary>=2.9.9
3. `PRODUCTION.md` - Updated with RDS setup guide

---

## üîß Maintenance & Monitoring

### View Database Logs
```bash
# Via AWS Console
https://console.aws.amazon.com/rds/ ‚Üí lautech-agentcore-db ‚Üí Logs & events

# Via CLI
aws rds download-db-log-file-portion \
  --db-instance-identifier lautech-agentcore-db \
  --log-file-name error/postgresql.log \
  --region us-east-1
```

### Monitor Performance
```bash
# Check CloudWatch metrics
aws cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name CPUUtilization \
  --dimensions Name=DBInstanceIdentifier,Value=lautech-agentcore-db \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average \
  --region us-east-1
```

### Manual Database Backup
```bash
# Create manual snapshot
aws rds create-db-snapshot \
  --db-instance-identifier lautech-agentcore-db \
  --db-snapshot-identifier lautech-manual-backup-$(date +%Y%m%d) \
  --region us-east-1
```

### Connect Directly to Database
```bash
# Get password from Secrets Manager
PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id lautech/rds/credentials \
  --region us-east-1 \
  --query SecretString \
  --output text | jq -r .password)

# Connect using psql
psql -h lautech-agentcore-db.c2x6a0cseynp.us-east-1.rds.amazonaws.com \
  -p 5432 \
  -U lautech_admin \
  -d lautech_db
```

---

## üí∞ Cost Estimate

### Current Configuration (db.t3.micro)
- **RDS Instance**: ~$13/month
- **Storage (20 GB)**: ~$2.30/month
- **Backups (7 days)**: ~$2/month (for 20 GB)
- **Data Transfer**: ~$1/month (minimal)
- **Secrets Manager**: ~$0.40/month

**Total**: ~$18.70/month

### Production Configuration (Recommended)
- **Instance**: db.t3.medium (~$60/month)
- **Multi-AZ**: +100% (~$120/month total)
- **Storage (100 GB)**: ~$11.50/month
- **Backups (30 days)**: ~$10/month

**Production Total**: ~$141.50/month

### Cost Optimization Tips
1. Use Reserved Instances (save 30-40%)
2. Enable auto-scaling for storage
3. Monitor and right-size instance
4. Use lifecycle policies for old backups

---

## üîí Security Recommendations for Production

### 1. Network Security
- [ ] Move RDS to private subnet
- [ ] Remove public accessibility
- [ ] Restrict security group to Lambda SG only
- [ ] Enable VPC flow logs

### 2. Access Control
- [ ] Enable IAM database authentication
- [ ] Rotate database password regularly
- [ ] Use least-privilege IAM policies
- [ ] Enable deletion protection

### 3. Monitoring & Alerting
- [ ] Set up CloudWatch alarms for:
  - High CPU (>80%)
  - Low storage space (<20%)
  - Failed connections
  - Slow queries
- [ ] Enable Enhanced Monitoring
- [ ] Configure AWS CloudTrail for audit logs

### 4. Backup & Recovery
- [ ] Test backup restoration process
- [ ] Enable Multi-AZ for automatic failover
- [ ] Export backups to S3 for long-term retention
- [ ] Document disaster recovery procedures

---

## üìû Support & Troubleshooting

### Common Issues

**Issue: Lambda can't connect to RDS**
- Check security group allows Lambda's security group
- Verify Lambda has VPC access (if RDS in private subnet)
- Confirm Secrets Manager permissions

**Issue: "Password authentication failed"**
- Verify secret is up to date in Secrets Manager
- Check if password was rotated
- Try retrieving secret manually and connecting via psql

**Issue: Slow query performance**
- Check CloudWatch metrics for high CPU/memory
- Review slow query logs
- Consider adding database indexes
- Upgrade instance class if needed

### Useful Commands

```bash
# Check RDS status
aws rds describe-db-instances \
  --db-instance-identifier lautech-agentcore-db \
  --region us-east-1

# View recent events
aws rds describe-events \
  --source-identifier lautech-agentcore-db \
  --source-type db-instance \
  --duration 60 \
  --region us-east-1

# Check security group rules
aws ec2 describe-security-groups \
  --group-ids sg-0e4268cc96512c408 \
  --region us-east-1
```

---

## ‚úÖ Completion Checklist

- [x] RDS PostgreSQL instance created
- [x] Database credentials stored in Secrets Manager
- [x] Security group configured
- [x] All data migrated successfully
- [x] Dance fee verified in database
- [ ] Lambda environment variables updated
- [ ] IAM permissions configured
- [ ] Code deployed to Lambda
- [ ] Integration tested
- [ ] Admin panel updated
- [ ] Monitoring configured
- [ ] Documentation updated
- [ ] Production security hardening

---

**Setup completed by**: Claude Code
**Date**: January 5, 2026
**Status**: ‚úÖ Ready for Lambda integration and testing
